#include <stdio.h>
#include <stdint.h>

typedef  uint8_t  UINT_8;
typedef  uint16_t UINT_16;
typedef  uint32_t UINT_32;
typedef  uint64_t UINT_64;

#if 0
uint8_t pkt_PTR[] = 
{
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x45, 0x00, 
0x00, 0x1F, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11, 0x7C, 0xCB, 

0x7F, 0x00, 0x00, 0x01,
0x7F, 0x00, 0x00, 0x01, 0x00, 0x35, 0x00, 0x7B, 0x00, 0x0B, 

//0x3C, 0xC3,
0x00, 0x00,

0x61, 0x62, 0x63
};
#endif

#if 1
uint8_t pkt_PTR[] = 
{
0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x00, 0x60, 0xa7, 0x08, 0x25, 0x78,
0x08, 0x00, 
// IP
0x45, 0x00,
0x00, 0x2f, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11, 
// ip header check sum.
//0x2f, 0xb4,
0x00, 0x00,

0x0a, 0x00, 0x01, 0x0b,
0xff, 0xff, 0xff, 0xff, 0xa0, 0x0b, 0x20, 0x96, 0x00, 0x1b,

//0x14, 0x33, 
0x00, 0x00,

0x00, 0x45,             /* packet type */ 
0x00, 0x00, 0x00, 0x00, /* base_mac_addr [2-5] */ 

0x30, 0x30, 0x37, 0x30, 0x39, 0x33, 0x7e, 0x00, /* SN */

0x00, 0x00, 0x00, 0x00, 

0x01 /* ring number */
};
#endif

#if 0
uint8_t pkt_PTR[] = 
{
0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x00, 0xae, 0x30, 0x12, 0x58, 0x00, 
0x08, 0x00, 0x45, 0x00,
0x00, 0x2f, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11, 0x3a, 0xbf,

0x00, 0x00, 0x00, 0x00,
0xff, 0xff, 0xff, 0xff, 0xb1, 0xef, 0x20, 0x96, 0x00, 0x1b,

//0x3f, 0xa9,
0x00, 0x00,

0x00, 0x45,             /* packet type */ 
0x30, 0x12, 0x58, 0x00, /* base_mac_addr [2-5] */

0x31, 0x32, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, /* SN */ 

0x00, 0x00,0x00, 0x00, 

0x01 /* ring number */
};
#endif


#if 0
uint8_t pkt_PTR[] = 
{
0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x00, 0xae, 0x30, 0x12, 0x58, 0x00, 
0x08, 0x00, 0x45, 0x00,
0x00, 0x2f, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11, 0x62, 0xb0, //<----- ip check sum

0xC0, 0xA8, 0x17, 0x66,                                     //<---- ip src 192.168.23.102
0xff, 0xff, 0xff, 0xff, 0xb1, 0xef, 0x20, 0x96, 0x00, 0x1b,

//0x67, 0x9a,
0x00, 0x00,

0x00, 0x45,             /* packet type */ 
0x30, 0x12, 0x58, 0x00, /* base_mac_addr [2-5] */

0x31, 0x32, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, /* SN */ 

0x00, 0x00,0x00, 0x00, 

0x01 /* ring number */
};
#endif

#if 0
uint8_t pkt_PTR[] = 
{
0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x00, 0xae, 0x30, 0x12, 0x58, 0x00, 
0x08, 0x00, 0x45, 0x00,
0x00, 0x2f, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11, 0x62, 0xb0, //<----- ip check sum

0xC0, 0xA8, 0x17, 0x66,                                     //<---- ip src 192.168.23.102
0xff, 0xff, 0xff, 0xff, 0xa0, 0x0b, 0x20, 0x96, 0x00, 0x1b,   //<--- src port 0xa0, 0x0b

//0x79, 0x7e,
0x00, 0x00,

0x00, 0x45,             /* packet type */ 
0x30, 0x12, 0x58, 0x00, /* base_mac_addr [2-5] */

0x31, 0x32, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, /* SN */ 

0x00, 0x00,0x00, 0x00, 

0x01 /* ring number */
};
#endif



int RRPC_pkt_size_bcast_CNS = sizeof(pkt_PTR);

#define RSG_swap16_MAC(a) ( (((a)<<8))&0xFF00 |  ((((a)>>8)&0x00FF)))

UINT_32 data_start = 42;

#define TTY_LIGHT_CYAN "\033[0;36m"
#define TTY_NO_COLOR   "\033[0m"

#define TTY_CHECKSUM  TTY_LIGHT_CYAN
#define TTY_NORMAL    TTY_NO_COLOR

int main()
{
        {
            // UDP Check Sum:
            UINT_32   sum = 0;
            UINT_16  *buf = (UINT_16*)(pkt_PTR + 14);
            UINT_16   len = 5*4;

            UINT_16   check_sum;

            
            // Calculate the sum
            while (len > 1)
            {
                sum += *buf++;
                len -= 2;
            }
            if ( len > 0 ) {
                sum += *((UINT_8 *)buf);
            }
            
            // Add the carries
            while (sum >> 16) {
                sum = (sum & 0xFFFF) + (sum >> 16);
            }
      
            // One's complement of sum
            check_sum = (UINT_16)(~sum);

            if (check_sum == 0)
                check_sum = 0xFFFF;

            *(UINT_16 *)(pkt_PTR + 24) = check_sum; // no swap
            
            ////////////////////////////////////////////////////////////////////
            {
                static UINT_16 s_old_check_sum = 0;
                UINT_32   i;
                if (s_old_check_sum != check_sum) {
                    printf("OSOTN: TX packet:\n");
                    for (i = 0; i < RRPC_pkt_size_bcast_CNS; i++) {
                        if (i != 0 && i%8 == 0)
                            printf("\n");
                        if (i >= 24 && i <= 25)
                            printf(TTY_CHECKSUM);
                        else
                            printf(TTY_NORMAL);

                        printf(" %3d = 0x%02x ", i, *(UINT_8 *)(pkt_PTR+i));
                    }
                    printf("\n");
                    s_old_check_sum = check_sum;
                }
            }
            ////////////////////////////////////////////////////////////////////
        }
}

